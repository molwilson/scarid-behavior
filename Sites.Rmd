---
title: "Fish & Benthic Community Data: Antigua, Barbuda, & Bonaire - Aug. 2017"
author: "Molly Wilson"
date: "8/8/2017"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
    number_sections: true
---
# Fish community data 
*required files: fish.csv, 

```{r, echo=FALSE,message=FALSE,warning=FALSE}
# set up
library(rmarkdown)
library(dplyr)
library(lazyeval)
library(tidyr)
library(ggplot2)
library(grid)
library(reshape2)
library(data.table)
```
```{r, echo=FALSE,message=FALSE,warning=FALSE}
# import files
setwd("~/github/Scarid-Behavior/data")
AB <-read.csv("fish.csv", stringsAsFactors=FALSE)
AB <- AB[rep(row.names(AB), AB$Number), 1:18] # expand to replicate rows if multiple fish were recorded
AB <- AB %>% select(-c(Time,Depth.ft,Surveyor,Number,Date))

bonherb<-read.csv("bon_herb.csv", stringsAsFactors=FALSE) %>% filter(Date==2017) %>% select(-Date) 
boncarn<-read.csv("bon_carn.csv", stringsAsFactors=FALSE)
boncarn <- boncarn[rep(row.names(boncarn), boncarn$Number), 1:16] %>% select(-c(Number,Diver,Date))
bonaire <- bind_rows(bonherb,boncarn) %>% filter(Site=="Oil Slick" | Site=="Karpata" | Site=="Front Porch" | Site=="18th Palm")

# bind Bonaire and AB data
fish <- bind_rows(AB,bonaire)

fish[fish==""]  <- NA 
fish[fish=="#NUM!"] <- NA
fish$Biomass <- as.numeric(fish$Biomass)
denuder <- fish %>% filter(Family=="Scaridae" | Family=="Acanthuridae")
scarid <- fish %>% filter(Family=="Scaridae")
acan <- fish %>% filter(Family=="Acanthuridae")
carnivore <- fish %>% filter(Family=="Serranidae" | Family=="Lutjanidae" | Family=="Carangidae") # need to expand appropriately, could specify potential predators
```

## Total fish population, by site
```{r,message=FALSE,warning=FALSE}
totfish.tran<- fish %>% filter(Biomass != 0) %>% group_by(Island,Site,Transect) %>% dplyr::summarize(BM.t=sum(Biomass)/1.2, DEN.t=n()/1.2, L.t=mean(Length))
site.totfish<-totfish.tran %>% group_by(Site) %>% dplyr::summarize(n=n(), tot.BM=mean(BM.t), tot.BM.se=(sd(BM.t))/sqrt(n), tot.DEN=mean(DEN.t), tot.DEN.se=(sd(DEN.t))/sqrt(n), tot.L=mean(L.t), tot.L.se=(sd(L.t))/sqrt(n)) %>% select(-n) # average across transects within each site
boxplot(BM.t~Site, las=2, data = totfish.tran)
```

## Total fish populations, by species and site
```{r,message=FALSE,warning=FALSE}
# Because not all species were present at each site/transect, I need to create template to add 0 values for biomass and density in transects where they are absent.
expand.tran <- fish %>% group_by(Site,Transect) %>% dplyr::summarize()
expand.species <- fish %>% expand(nesting(Species,Family),Site)
temp.species <- full_join(expand.species,expand.tran,by="Site")

# Then I can join species/transect data with this species/transect template, and replace empty rows with 0 values

# biomass and density, by site and species:
species.tran<- fish %>% filter(Biomass != 0) %>% group_by(Site,Transect,Species) %>% dplyr::summarize(BM.t=sum(Biomass)/1.2, DEN.t=n()/1.2) %>% right_join(temp.species, by=c("Site","Transect","Species")) # join transect-level data with template
species.tran[is.na(species.tran)] <- 0 # convert NAs to 0 biomass/density in transects where a species is not present
species.site<-species.tran %>% group_by(Site,Species,Family) %>% dplyr::summarize(n=n(), BM=mean(BM.t), BM.se=(sd(BM.t))/sqrt(n), DEN=mean(DEN.t), DEN.se=(sd(DEN.t))/sqrt(n))

# length, by site and species (calculated separately because transects missing length values should not be replaced with 0 values)
species.L.tran <- fish %>% group_by(Site,Transect,Species) %>% dplyr::summarize(L.t=mean(Length))
species.L.site<-species.L.tran %>% group_by(Site,Species) %>% dplyr::summarize(L.n=n(),L=mean(L.t), L.se=(sd(L.t))/sqrt(L.n))
species.site <- species.site %>% left_join(species.L.site) # sample size will be different for length (L.n - only transects where species was observed) vs. biomass/density (n - all transects) calculations
```

## Total denuder populations, by site
```{r,message=FALSE,warning=FALSE}
herb.tran<- denuder %>% filter(Biomass != 0) %>% group_by(Site,Transect) %>% dplyr::summarize(BM.t=sum(Biomass)/1.2, DEN.t=n()/1.2, L.t=mean(Length))
site.herb<-herb.tran %>% group_by(Site) %>% dplyr::summarize(n=n(), herb.BM=mean(BM.t), herb.BM.se=(sd(BM.t))/sqrt(n), herb.DEN=mean(DEN.t), herb.DEN.se=(sd(DEN.t))/sqrt(n), herb.L.s=mean(L.t), herb.L.se=(sd(L.t))/sqrt(n)) %>% select(-n)
```

## Total acanthurid populations, by site
```{r,message=FALSE,warning=FALSE}
acan.tran<- acan %>% filter(Biomass != 0) %>% group_by(Site,Transect) %>% dplyr::summarize(BM.t=sum(Biomass)/1.2, DEN.t=n()/1.2, L.t=mean(Length))
site.acan<-acan.tran %>% group_by(Site) %>% dplyr::summarize(n=n(), acan.BM=mean(BM.t), acan.BM.se=(sd(BM.t))/sqrt(n), acan.DEN=mean(DEN.t), acan.DEN.se=(sd(DEN.t))/sqrt(n), acan.L=mean(L.t), acan.L.se=(sd(L.t))/sqrt(n)) %>% select(-n)
```

## Total scarid populations, by site
```{r,message=FALSE,warning=FALSE}
scarid.tran<- scarid %>% filter(Biomass != 0) %>% group_by(Site,Transect) %>% dplyr::summarize(BM.t=sum(Biomass)/1.2, DEN.t=n()/1.2, L.t=mean(Length))
site.scar<-scarid.tran %>% group_by(Site) %>% dplyr::summarize(n=n(), scar.BM=mean(BM.t), scar.BM.se=(sd(BM.t))/sqrt(n), scar.DEN=mean(DEN.t), scar.DEN.se=(sd(DEN.t))/sqrt(n), scar.L=mean(L.t), scar.L.se=(sd(L.t))/sqrt(n)) %>% select(-n)
```

## Scarid populations, by species and site
```{r,message=FALSE,warning=FALSE}
scarid.species <- species.site %>% filter(Family=="Scaridae") %>% select(-Family,-n) %>% ungroup()

# spread to site-level df with columns for each species' variables (ran into errors with unite/spread, so instead will do separately for each species)
viride <- scarid.species %>% filter(Species=="Sparisoma viride") %>% select(-Species)
names(viride)[2:8] <- c("viride.BM","viride.BM.se","viride.DEN","viride.DEN.se","viride.L.n","viride.L","viride.L.se")
vetula <- scarid.species %>% filter(Species=="Scarus vetula") %>% select(-Species)
names(vetula)[2:8] <- c("vetula.BM","vetula.BM.se","vetula.DEN","vetula.DEN.se","vetula.L.n","vetula.L","vetula.L.se")
aurofren <- scarid.species %>% filter(Species=="Sparisoma aurofrenatum") %>% select(-Species)
names(aurofren)[2:8] <- c("aurofren.BM","aurofren.BM.se","aurofren.DEN","aurofren.DEN.se","aurofren.L.n","aurofren.L","aurofren.L.se")
site.scar.sp <- left_join(viride,vetula,by="Site") %>% left_join(aurofren,by="Site")
```

## Scarid populations, by phase and site
I will expand again here to make template with all phase/site combinations, then join transect level data
```{r,message=FALSE,warning=FALSE}
expand.tran <- fish %>% group_by(Site,Transect) %>% dplyr::summarize()
expand.phase <- scarid %>% expand(Phase,Site)
temp.phase <- full_join(expand.phase,expand.tran,by="Site")

# scarid biomass and density, by site and phase:
phase.tran <- scarid %>% filter(Biomass != 0) %>% group_by(Site,Transect,Phase) %>% dplyr::summarize(BM.t=sum(Biomass)/1.2, DEN.t=n()/1.2) %>% right_join(temp.phase, by=c("Site","Transect","Phase")) # join transect-level data with template
phase.tran[is.na(phase.tran)] <- 0 # convert NAs to 0 biomass/density in transects where a species is not present
phase.site<-phase.tran %>% group_by(Site,Phase) %>% dplyr::summarize(n=n(), BM=mean(BM.t), BM.se=(sd(BM.t))/sqrt(n), DEN=mean(DEN.t), DEN.se=(sd(DEN.t))/sqrt(n))

# length, by site and species (calculated separately because transects missing length values should not be replaced with 0 values)
phase.L.tran <- scarid %>% group_by(Site,Transect,Phase) %>% dplyr::summarize(L.t=mean(Length))
phase.L.site<-phase.L.tran %>% group_by(Site,Phase) %>% dplyr::summarize(L.n=n(),L=mean(L.t), L.se=(sd(L.t))/sqrt(L.n))
phase.site <- phase.site %>% left_join(phase.L.site) # sample size will be different for length (L.n - only transects where species was observed) vs. biomass/density (n - all transects) calculations

# spread to site-level df with columns for each species' variables (ran into errors with unite/spread, so instead will do separately for each species)
juvenile <- phase.site %>% filter(Phase=="j") %>% select(-Phase,-n)
names(juvenile)[2:8] <- c("juvenile.BM","juvenile.BM.se","juvenile.DEN","juvenile.DEN.se","juvenile.L.n","juvenile.L","juvenile.L.se")
initial <- phase.site %>% filter(Phase=="i") %>% select(-Phase,-n)
names(initial)[2:8] <- c("intial.BM","intial.BM.se","intial.DEN","intial.DEN.se","intial.L.n","intial.L","intial.L.se")
terminal <- phase.site %>% filter(Phase=="t") %>% select(-Phase,-n)
names(terminal)[2:8] <- c("terminal.BM","terminal.BM.se","terminal.DEN","terminal.DEN.se","terminal.L.n","terminal.L","terminal.L.se")
site.scar.ph <- left_join(juvenile,initial,by="Site") %>% left_join(terminal,by="Site")
```

## Total carnivore populations, by site
I will need to use expanded template, because some transects had no serranid/lutjanids
*Could add gape size restrictions to determine actual predator threat?*
```{r,message=FALSE,warning=FALSE}
carnivore.tran<- carnivore %>% filter(Biomass != 0) %>% group_by(Site,Transect) %>% dplyr::summarize(BM.t=sum(Biomass)/1.2, DEN.t=n()/1.2) %>% right_join(expand.tran,by=c("Site","Transect"))
carnivore.tran[is.na(carnivore.tran)] <- 0 
site.carn<-carnivore.tran %>% group_by(Site) %>% dplyr::summarize(n=n(), carn.BM=mean(BM.t), carn.BM.se=(sd(BM.t))/sqrt(n), carn.DEN=mean(DEN.t), carn.DEN.se=(sd(DEN.t))/sqrt(n)) %>% select(-n)
```

# Benthic & rugosity data
*required files: benthic_anu.csv, benthic_bon.csv, rugosity.csv*

```{r, echo=FALSE,message=FALSE,warning=FALSE}
setwd("~/github/Scarid-Behavior/data")
benthic<-read.csv("benthic_anu.csv", stringsAsFactors=FALSE)
rugosity<-read.csv("rugosity.csv", stringsAsFactors=FALSE)
```

## Percent cover
```{r, echo=FALSE,message=FALSE,warning=FALSE}
# Because not all categories were present within each meter, I need to create template to add 0 values in meters where they were absent.
expand.meter <- benthic %>% group_by(Site,Transect,Meter) %>% dplyr::summarize()
expand.category <- benthic %>% expand(nesting(Code),Site)
temp.benthic <- full_join(expand.meter,expand.category,by="Site")

# Then I can join benthic data with this template, and replace empty rows with 0 values
benthic.meter<- benthic %>% group_by(Site,Transect,Meter,Code) %>% dplyr::summarize(count.m=n()) %>% right_join(temp.benthic, by=c("Site","Transect","Meter","Code")) # join transect-level data with template
benthic.meter[is.na(benthic.meter)] <- 0 # convert NAs to 0 biomass/density in transects where a species is not present

# Calculating percent cover on potential substrate (i.e. not sand), remove meters that were 100% sand cover (no potential susbtrate)
sand.meter <- benthic.meter %>% filter(Code=="sand") %>% dplyr::rename(count.sand=count.m) %>% select(-Code) 
benthic.meter <- left_join(benthic.meter,sand.meter,by=c("Site","Transect","Meter")) %>% mutate(cover.m=100*count.m/(10-count.sand)) %>% filter(!is.nan(cover.m)) %>% filter(Code!="sand") 

benthic.trans<-benthic.meter %>% group_by(Site,Transect,Code) %>% dplyr::summarize(cover.t=mean(cover.m))
benthic.site<-benthic.trans %>% group_by(Site,Code) %>% dplyr::summarize(n=n(),cover=mean(cover.t),cover.se=sd(cover.t)/sqrt(n)) %>% select(-n)

# Now need to spread data into wide site-level format
benthic.wide<-dcast(setDT(benthic.site),Site~Code,value.var=c("cover","cover.se"))
```

## Algal canopy heights
```{r, echo=FALSE,message=FALSE,warning=FALSE}
benthic$Height<- as.numeric(benthic$Height)
canopy.site <- benthic %>% filter(Height>1) %>% group_by(Site,Transect,Meter,Code) %>% dplyr::summarize(canopy.m=mean(Height)) %>% group_by(Site,Transect,Code) %>% dplyr::summarize(canopy.t=mean(canopy.m)) %>% group_by(Site,Code) %>% dplyr::summarize(n=n(),canopy=mean(canopy.t),canopy.se=sd(canopy.t)/sqrt(n)) %>% select(-n)

# spread into wide site-level format, join with percent cover data in benthic.wide
canopy.wide <- dcast(setDT(canopy.site),Site~Code,value.var=c("canopy","canopy.se"))
site.benthic<- left_join(benthic.wide,canopy.wide,by="Site")
```

## Rugosity
```{r, echo=FALSE,message=FALSE,warning=FALSE}
site.rugosity <- rugosity  %>% group_by(Site,Transect) %>% dplyr::summarize(rugosity.t=mean(Rugosity.cm)/100) %>% group_by(Site) %>% dplyr::summarize(n=n(),rugosity=mean(rugosity.t),rugosity.se=sd(rugosity.t)/sqrt(n)) %>% select(-n) %>% rbind(c("Pallaster West",1.7006,NA)) # missing data for Pallaster West, will use mean of Pallaster East and Mid because reef structure across all three was extremely similar
site.rugosity$rugosity<-as.numeric(as.character(site.rugosity$rugosity))
site.rugosity$rugosity.se<-as.numeric(as.character(site.rugosity$rugosity.se))
site.benthic <- full_join(site.benthic, site.rugosity,by="Site")
```


# Integrating and exporting.csvs
```{r, echo=FALSE,message=FALSE,warning=FALSE}
setwd("~/github/Scarid-Behavior/data")
bonbenthic <- read.csv("benthic_bon.csv",stringsAsFactors = FALSE)
site.benthic <- bind_rows(site.benthic,bonbenthic)
write.csv(site.benthic,file="site.benthic.csv")

site.fish <- site.totfish %>% left_join(site.herb,by="Site") %>% left_join(site.acan,by="Site") %>% left_join(site.scar,by="Site") %>% left_join(site.scar.sp,by="Site") %>% left_join(site.scar.ph,by="Site") %>% left_join(site.carn,by="Site")
write.csv(site.fish,file="site.fish.csv")
write.csv(species.site,file="species.site.csv")
```