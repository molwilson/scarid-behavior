---
title: "Variance in scarid grazing behavior across Caribbean reef sites"
author: "Molly Wilson"
date: "3/1/2019"
output: html_document
---

# Variance in scarid grazing behavior across Caribbean reef sites
### Formatted as: Coral Reefs note (<2900 words)

```{r, echo=F, message=F, warning=F}
library(here)
library(tidyverse)
library(ggplot2)
library(gridExtra)
library(grid)
library(ggfortify)
library(ggsignif) # boxplot stats
library(EnvStats) # boxplot stats
library(mgcv)
library(MuMIn)
library(knitr)

sum_site <- read.csv(here("data","sum_site.csv"), stringsAsFactors=F) %>%
  select(-X) %>% 
  mutate(island = factor(island, levels = c("Bonaire","Antigua","Barbuda"))) %>%
  arrange(island)
sum_id <- read.csv(here("data","sum_id.csv"), stringsAsFactors=F) %>%
  select(-X) %>% 
  filter(species_code %in% c("stop","qup")) %>%
  mutate(island = factor(island, levels = c("Bonaire","Antigua","Barbuda"))) %>%
  arrange(island) %>%
  filter(fr <= 3000)

### data subset: excluding sites with low sample sizes, including only individuals 15-35 cm
sum_id_sub <- sum_id %>%
  filter(phase == "i" & length_cm >= 15 & length_cm <= 35 & !(species_code == "stop" & site == "Pallaster West") & !(species_code == "qup" & site %in% c("Pallaster East","Rendezvous","Turtle Bay")))

sum_ssp_sub <- sum_id_sub %>% 
  group_by(species, species_code, site, island) %>%
  summarize(
    n=n(),
    length_mean=mean(length_cm),
    length_se=sd(length_cm)/sqrt(n),
    g_frac_mean=mean(g_frac),
    g_frac_median=median(g_frac),
    g_frac_se=sd(g_frac)/sqrt(n),
    br_mean=mean(br,na.rm=TRUE),
    br_median=median(br,na.rm=TRUE),
    br_se=sd(br,na.rm=TRUE)/sqrt(n),
    fr_mean=mean(fr),
    fr_median=median(fr),
    fr_se=sd(fr)/sqrt(n),
    for_dur_mean=mean(for_dur,na.rm=TRUE),
    for_dur_median=median(for_dur,na.rm=TRUE),
    for_dur_se=sd(for_dur,na.rm=TRUE)/sqrt(n),
    for_bites_mean=mean(for_bites,na.rm=TRUE),
    for_bites_median=median(for_bites,na.rm=TRUE),
    for_bites_se=sd(for_bites,na.rm=TRUE)/sqrt(n)
    )

```

## Figuring out sample sizes/site consolidations...

```{r}
sample_exp <- sum_id %>% 
  filter(phase == "i" & length_cm >= 15 & length_cm <= 35) %>%
  group_by(species, species_code, site, island) %>%
  summarize(
    n=n())

ggplot(filter(sum_id, 
              phase=="i" & length_cm >= 15 & length_cm <= 50 & species_code!="rbp"), 
       aes(factor(site), fr)) + 
  geom_violin(aes(fill=island)) +
  geom_boxplot(width=0.1) + 
  labs(y = "Feeding Rate (bites/hr)", x = "", title = "Hourly feeding rates (i. phase)") +
  geom_signif(comparisons = list(c("Antigua", "Barbuda"),c("Antigua","Bonaire"),c("Barbuda","Bonaire")), map_signif_level=TRUE) +
  facet_grid(.~species) + 
  stat_n_text(angle = 90) +
  scale_fill_brewer(palette="Blues") +
  theme_bw() +
  theme(strip.text = element_text(face = "italic")) +
  theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90, hjust = 1)) 
```


## Table 1. Variable definitions
```{r, echo=F, message=F}
Variable <- c('Time spent grazing','Bite rate','Feeding rate','Foray size')
Definition <- c('Proportion of time spent grazing during follow','Bite rate while actively feeding','Bite rate over total follow time','Number of consecutive bites taken during single grazing foray')
Unit <- c('fraction','bites/second','bites/minute','bites/foray')
var.table <- data.frame(Variable,Definition,Unit)
kable(var.table)
```

## 
```{r, eval = F, echo=F, message=F, warning=F}
ggplot(filter(sum_ssp, species_code != "rbp" & phase == "i"), aes(x=factor(site, levels = sum_site$site), y=fr_mean)) +
    geom_bar(stat = "identity", aes(fill = island), position = "dodge") +
    geom_errorbar(aes(ymin=fr_mean-fr_se, ymax=fr_mean+fr_se), width=.2,
                 position=position_dodge(.9)) +
    facet_grid(~species) +
    scale_fill_brewer(palette = "Blues") +
    labs(title="Mean feeding rates of individuals (initial phase)", 
         y="Feeding rate (bites/min)", 
         x="Site") +
    theme_bw() +
    theme(strip.text = element_text(face = "italic"), 
          axis.text.x = element_text(angle = 90, hjust = 1), 
          plot.title = element_text(hjust = 0.5))
```


```{r, echo = F, message = F, warning = F}
# Panel graph of site differences

 # published feeding rate (bites/min) for reference lines if needed
ref_qup15 <- (3329-33*15)/60
ref_qup30 <- (3329-33*30)/60
ref_stop15 <- (1089-17*15-56)/60
ref_stop30 <- (1089-17*30-56)/60

fr_qup <- 
  ggplot(filter(sum_ssp, species_code == "qup" & phase == "i"), 
         aes(x=factor(site, levels = sum_site$site), y=fr_mean)) +
  geom_bar(stat = "identity", aes(fill = island), position = "dodge") +
  geom_errorbar(aes(ymin=fr_mean-fr_se, ymax=fr_mean+fr_se), width=.2,
                 position=position_dodge(.9)) +
  scale_fill_brewer(palette = "Blues") +
  #geom_abline(slope=0, intercept=ref_qup15,  col = "red",lty=2) +
  #geom_abline(slope=0, intercept=ref_qup25,  col = "red",lty=2) +
  #ylim(0, 50) +
  labs(y = "Feeding rate \n (bites/min)", 
       title = "S. vetula") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5, face = "italic"),
        plot.margin = margin(5, 0, 0, 5, unit = "pt"),
        strip.text = element_text(face = "italic"), 
        axis.text.x=element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size=8),
        legend.position = "none")

fr_stop <- 
  ggplot(filter(sum_ssp, species_code == "stop" & phase == "i"), 
         aes(x=factor(site, levels = sum_site$site), y=fr_mean)) +
  geom_bar(stat = "identity", aes(fill = island), position = "dodge") +
  geom_errorbar(aes(ymin=fr_mean-fr_se, ymax=fr_mean+fr_se), width=.2,
                 position=position_dodge(.9)) +
  scale_fill_brewer(palette = "Blues") +
  #geom_abline(slope=0, intercept=ref_stop15,  col = "red",lty=2) +
  #geom_abline(slope=0, intercept=ref_stop25,  col = "red",lty=2) +
  labs(y = "",
       # y = "S. vetula \nFeeding rate (bites/hr)", 
       title = "S. viride") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5, face = "italic"),
        plot.margin = margin(5, 4, 0, 0, unit = "pt"),
        strip.text = element_text(face = "italic"), 
        axis.text.x=element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none")

br_qup <- 
  ggplot(filter(sum_ssp, species_code == "qup" & phase == "i"), 
         aes(x=factor(site, levels = sum_site$site), y=br_mean)) +
  geom_bar(stat = "identity", aes(fill = island), position = "dodge") +
  geom_errorbar(aes(ymin=br_mean-br_se, ymax=br_mean+br_se), width=.2,
                 position=position_dodge(.9)) +
  scale_fill_brewer(palette = "Blues") +
  labs(y = "Bite rate \n(bites/sec)", 
       x = "", 
       title = "") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.margin = margin(0, 0, 0, 5, unit = "pt"),
        strip.text = element_text(face = "italic"), 
        axis.text.x=element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size=8),
        legend.position = "none")

br_stop <- 
  ggplot(filter(sum_ssp, species_code == "stop" & phase == "i"), 
         aes(x=factor(site, levels = sum_site$site), y=br_mean)) +
  geom_bar(stat = "identity", aes(fill = island), position = "dodge") +
  geom_errorbar(aes(ymin=br_mean-br_se, ymax=br_mean+br_se), width=.2,
                 position=position_dodge(.9)) +
  scale_fill_brewer(palette = "Blues") +
  labs(y = "",
       # y = "S. vetula \nFeeding rate (bites/hr)", 
       x = "", 
       title = "") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.margin = margin(0, 4, 0, 0, unit = "pt"),
        strip.text = element_text(face = "italic"), 
        axis.text.x=element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none")

gfrac_qup <- 
  ggplot(filter(sum_ssp, species_code == "qup" & phase == "i"), 
         aes(x=factor(site, levels = sum_site$site), y=g_frac_mean)) +
  geom_bar(stat = "identity", aes(fill = island), position = "dodge") +
  geom_errorbar(aes(ymin=g_frac_mean-g_frac_se, ymax=g_frac_mean+g_frac_se), width=.2,
                 position=position_dodge(.9)) +
  scale_fill_brewer(palette = "Blues") +
  labs(y = "Time grazing \n(fraction)", 
       x = "", 
       title = "") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.margin = margin(0, 0, 0, 5, unit = "pt"),
        strip.text = element_text(face = "italic"), 
        axis.text.x=element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size=8),
        legend.position = "none")

gfrac_stop <- 
  ggplot(filter(sum_ssp, species_code == "stop" & phase == "i"), 
         aes(x=factor(site, levels = sum_site$site), y=g_frac_mean)) +
  geom_bar(stat = "identity", aes(fill = island), position = "dodge") +
  geom_errorbar(aes(ymin=g_frac_mean-g_frac_se, ymax=g_frac_mean+g_frac_se), width=.2,
                 position=position_dodge(.9)) +
  scale_fill_brewer(palette = "Blues") +
  labs(y = "",
       x = "", 
       title = "") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.margin = margin(0, 4, 0, 0, unit = "pt"),
        strip.text = element_text(face = "italic"), 
        axis.text.x=element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none")

fi_qup <- 
  ggplot(filter(sum_ssp, species_code == "qup" & phase == "i"), 
         aes(x=factor(site, levels = sum_site$site), y=for_bites_mean)) +
  geom_bar(stat = "identity", aes(fill = island), position = "dodge") +
  geom_errorbar(aes(ymin=for_bites_mean-for_bites_se, ymax=for_bites_mean+for_bites_se), width=.2,
                 position=position_dodge(.9)) +
  scale_fill_brewer(palette = "Blues") +
  labs(y = "Foray length\n(bites/foray)", 
       x = "", 
       title = "") +
  theme_bw() + 
  theme(plot.margin = margin(0, 0, 0, 5, unit = "pt"),
        axis.title.y = element_text(size=8),
        axis.text.x = element_text(angle = 45, hjust = 1, size=7),
        legend.position = "none")

fi_stop <- 
  ggplot(filter(sum_ssp, species_code == "stop" & phase == "i"), 
         aes(x=factor(site, levels = sum_site$site), y=for_bites_mean)) +
  geom_bar(stat = "identity", aes(fill = island), position = "dodge") +
  geom_errorbar(aes(ymin=for_bites_mean-for_bites_se, ymax=for_bites_mean+for_bites_se), width=.2,
                 position=position_dodge(.9)) +
  scale_fill_brewer(palette = "Blues") +
  labs(y = "",
       x = "", 
       title = "") +
  theme_bw() + 
  theme(plot.margin = margin(0, 4, 0, 0, unit = "pt"),
        axis.text.x = element_text(angle = 45, hjust = 1, size=7),
        legend.position = "none")


legend_plot <- 
  ggplot(filter(sum_ssp, species_code == "stop" & phase == "i"), 
         aes(x=factor(site, levels = sum_site$site), y=g_frac_mean)) +
  geom_bar(stat = "identity", aes(fill = island), position = "dodge") +
  scale_fill_brewer(palette = "Blues") +
  labs(y = "",
       x = "", 
       title = "") +
  theme_bw() +
  theme(legend.position = "right",
        legend.title = element_blank())

get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
  }
legend <- get_legend(legend_plot)


grid.arrange(
  arrangeGrob(fr_qup, fr_stop, gfrac_qup, gfrac_stop, br_qup, br_stop, fi_qup, fi_stop, ncol=2, heights = c(1.5,1.5,1.5,3)), 
              arrangeGrob(legend), 
              ncol=2, widths = c(5,1))

g <- arrangeGrob(
  arrangeGrob(fr_qup, fr_stop, gfrac_qup, gfrac_stop, br_qup, br_stop, fi_qup, fi_stop, ncol=2, heights = c(1,1,1,1.5)), 
              arrangeGrob(legend), 
              ncol=2, widths = c(5,1))

ggsave(here("figs/behavior_panel.png"),g)
```

The variations in grazing behaviors demonstrated here may be driven by several potential underlying mechanisms. Figure 3 shows the relationships between various reef characteristics and scarid feeding rate. Because study sites expectedly varied across a number of interrelated fish and benthic dimensions (PCA - appendix?), it is impossible to conclusively establish any explicit mechanisms here. Instead I present several hypotheses that may be driving these observed behavioral trends and discuss evidence for and implications of each.

```{r, echo=F, message=F, warning=F}
fr_q1 <- ggplot(filter(sum_ssp, species_code == "qup" & phase == "i"), aes(x = scar_bm/1000, y = fr_mean)) +
  geom_smooth(method="loess", span=1) +
  geom_point(shape=18) +
  ylim(-10, 60) +
  labs(y = "",
       title = "") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.margin = margin(0, 1, 0, 0, unit = "pt"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank()
        )

fr_q2 <- ggplot(filter(sum_ssp, species_code == "qup" & phase == "i"), aes(x = consp_den, y = fr_mean)) +
  geom_smooth(method="loess", span=1) +
  geom_point(shape=18) +
  ylim(-10, 60) +
  labs(y = "", 
       title = "") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        plot.margin = margin(0, 1, 0, 1, unit = "pt"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank()
        )

fr_q3 <- ggplot(filter(sum_ssp, species_code == "qup" & phase == "i"), aes(x = rugosity, y = fr_mean)) +
  geom_smooth(method="loess", span=1) +
  geom_point(shape=18) +
  ylim(-10, 60) +
  labs(y = "", 
       title = "") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        plot.margin = margin(0, 1, 0, 1, unit = "pt"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank()
        )

fr_q4 <- ggplot(filter(sum_ssp, species_code == "qup" & phase == "i"), aes(x = ta_canopy, y = fr_mean)) +
  geom_smooth(method="loess", span=1) +
  geom_point(shape=18) +
  ylim(-10, 60) +
  labs(y = "", 
       title = "") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        plot.margin = margin(0, 1, 0, 1, unit = "pt"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank()
        )

fr_q5 <- ggplot(filter(sum_ssp, species_code == "qup" & phase == "i"), aes(x = ta_cover, y = fr_mean)) +
  geom_smooth(method="loess", span=1) +
  geom_point(shape=18) +
  ylim(-10, 60) +
  labs(y = "",
       title = "") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        plot.margin = margin(0, 1, 0, 1, unit = "pt"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank()
        )

fr_q7 <- ggplot(filter(sum_ssp, species_code == "qup" & phase == "i"), aes(x = ma_cover, y = fr_mean)) +
  geom_smooth(method="loess", span=1) +
  geom_point(shape=18) +
  ylim(-10, 60) +
  labs(y = "", 
       title = "") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        plot.margin = margin(0, 1, 0, 1, unit = "pt"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank()
        )

fr_s1 <- ggplot(filter(sum_ssp, species_code == "stop" & phase == "i"), aes(x = scar_bm/1000, y = fr_mean)) +
  geom_smooth(method="loess", span=1) +
  geom_point(shape=18) +
  ylim(-5, 20) +
  labs(y = "",
       x = expression(atop(NA, atop(textstyle('Scarid biomass'),
                               textstyle('(kg/100m'^2*')')))),
       title = "") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.margin = margin(0, 1, 0, 0, unit = "pt"),
        axis.title.x = element_text(size = 9)
        )

fr_s2 <- ggplot(filter(sum_ssp, species_code == "stop" & phase == "i"), aes(x = consp_den, y = fr_mean)) +
  geom_smooth(method="loess", span=1) +
  geom_point(shape=18) +
  ylim(-5, 20) +
  labs(y = "", 
       x = expression(atop(NA, atop(textstyle('Conspec. density'),
                               textstyle('(indv/100m'^2*')')))),
       title = "") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(size = 9),
        plot.margin = margin(0, 1, 0, 1, unit = "pt")
        )

fr_s3 <- ggplot(filter(sum_ssp, species_code == "stop" & phase == "i"), aes(x = rugosity, y = fr_mean)) +
  geom_smooth(method="loess", span=1) +
  geom_point(shape=18) +
  ylim(-5, 20) +
  labs(y = "", 
       x = expression(atop(NA, atop(textstyle('Rugosity'),
                               textstyle('  ')))), 
       title = "") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(size = 9),
        plot.margin = margin(0, 1, 0, 1, unit = "pt")
        )

fr_s4 <- ggplot(filter(sum_ssp, species_code == "stop" & phase == "i"), aes(x = ta_canopy, y = fr_mean)) +
  geom_smooth(method="loess", span=1) +
  geom_point(shape=18) +
  ylim(-5, 20) +
  labs(y = "", 
       x = expression(atop(NA, atop(textstyle('EAM canopy'),
                               textstyle('height (mm)')))), 
       title = "") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(size = 9),
        plot.margin = margin(0, 1, 0, 1, unit = "pt")
        )

fr_s5 <- ggplot(filter(sum_ssp, species_code == "stop" & phase == "i"), aes(x = ta_cover, y = fr_mean)) +
  geom_smooth(method="loess", span=1) +
  geom_point(shape=18) +
  ylim(-5, 20) +
  labs(y = "", 
       x = expression(atop(NA, atop(textstyle('EAM cover'),
                               textstyle('(%)')))), 
       title = "") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(size = 9),
        plot.margin = margin(0, 1, 0, 1, unit = "pt")
        )

fr_s7 <- ggplot(filter(sum_ssp, species_code == "stop" & phase == "i"), aes(x = ma_cover, y = fr_mean)) +
  geom_smooth(method="loess", span=1) +
  geom_point(shape=18) +
  ylim(-5, 20) +
  labs(y = "", 
       x = expression(atop(NA, atop(textstyle('Macroalgal cover'),
                               textstyle('(%)')))), 
       title = "") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.x = element_text(size = 9),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        plot.margin = margin(0, 1, 0, 1, unit = "pt")
        )

label_vet = textGrob("S. vetula", gp=gpar(fontface="italic"), rot=270)
label_vir = textGrob("S. viride", gp=gpar(fontface="italic"), rot=270)

g <- grid.arrange(left = "Feeding rate (bites/min.)",
  arrangeGrob(fr_q1, fr_q3, fr_q4, fr_q5, fr_q7, ncol=5, right = label_vet),
  arrangeGrob(fr_s1, fr_s3, fr_s4, fr_s5, fr_s7, ncol=5, right = label_vir), 
  nrow=2, heights = c(1,1.2)) 

ggsave(here("figs/biplot_panel.png"),g)
```

*Bite content hypothesis.* Differences in scarid grazing preferences can be driven by (local differences in) nutrient availability and distribution (Carlson, Tootell, Mumby, etc.). Algal communities on Caribbean reefs can vary greatly in terms of canopy height, percent cover, species composition, and nutrient content ().

(no conclusive trends, but FR tended to decrease with increasing EAM canopy height and to some extent EAM and macroalgal percent cover)

In higher canopy sites, scarids may be obtaining more biomass of food per bite than in areas with heavily cropped algae, requiring them to take fewer bites to obtain the same nutritional intake.

Implications: 
-maybe better metric than bite/feeding rate
-reduced grazing impact if not clearing substrate
-reinforcing loop


```{r, echo=F, message=F, warning=F}
# grazing impact (vg ~ volume grazed) of fish from behavioral surveys
sum_id_vg <- sum_id %>%
  filter(species_code != "rbp") %>%
  mutate(
    bs = ifelse(species_code == "stop", 5.257*10^-4*length_cm^2, 4.013*10^-4*length_cm^2), # adding bite size equations from Mumby
    bh_capped = ifelse(ta_canopy < 2*sqrt(bs)/(22/7), ta_canopy, 2*sqrt(bs)/(22/7)), # if ta_canopy exceeds diameter of bite size, bite height is capped at bite size
    bv = bs*ta_canopy,
    bv_capped = bs*bh_capped,
    vg = fr*bv,
    vg_capped = fr*bv_capped,
    island = factor(island, levels = c("Bonaire","Antigua","Barbuda"))
) %>%
  arrange(island)

# summing by site, species, and phase
sum_ssp_vg <- sum_id_vg %>% 
  filter(length_cm >= 15 & length_cm <= 30) %>%
  group_by(site, ta_canopy, island, species, species_code, phase) %>% 
  summarize(
    n=n(),
    vg_mean=mean(vg),
    vg_se=sd(vg)/sqrt(n),
    vg_capped_mean=mean(vg_capped),
    vg_capped_se=sd(vg_capped)/sqrt(n),
    fr_mean=mean(fr)
    ) %>% 
  select(-n)

# keep this to get legend for panel
vg_facet <- ggplot(filter(sum_ssp_vg, species_code != "rbp" & phase == "i"), aes(x=factor(site, levels = sum_site$site), y=vg_mean)) +
    geom_bar(stat = "identity", aes(fill = island), position = "dodge") +
    geom_errorbar(aes(ymin=vg_mean-vg_se, ymax=vg_mean+vg_se), width=.2,
                 position=position_dodge(.9)) +
    facet_grid(~species) +
    scale_fill_brewer(palette = "Blues") +
    labs(title="Mean grazing impact by volume (initial phase)", 
         y="Grazing impact (cm3/hr)", 
         x="Site") +
    theme_bw() +
    theme(strip.text = element_text(face = "italic"), 
          axis.text.x = element_text(angle = 45, hjust = 1), 
          legend.title = element_blank())

vg_qup <- ggplot(filter(sum_ssp_vg, species_code == "qup" & phase == "i"), 
                 aes(x=factor(site, levels = sum_site$site), y=vg_mean)) +
    geom_bar(stat = "identity", aes(fill = island), position = "dodge") +
    geom_errorbar(aes(ymin=vg_mean-vg_se, ymax=vg_mean+vg_se), width=.2,
                 position=position_dodge(.9)) +
  scale_fill_brewer(palette = "Blues") +
  labs(y = expression('Grazing impact (cm'^3*'/hr)'), 
       x = "", 
       title = "S. vetula") +
  theme_bw() + 
  theme(plot.margin = margin(1, 0, 0, 5, unit = "pt"),
        axis.title.y = element_text(size=10),
        axis.text.x = element_text(angle = 45, hjust = 1, size=7),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5, face = "italic")
        )

vg_stop <- ggplot(filter(sum_ssp_vg, species_code == "stop" & phase == "i"), 
                  aes(x=factor(site, levels = sum_site$site), y=vg_mean)) +
    geom_bar(stat = "identity", aes(fill = island), position = "dodge") +    
    geom_errorbar(aes(ymin=vg_mean-vg_se, ymax=vg_mean+vg_se), width=.2,
                 position=position_dodge(.9)) +
  scale_fill_brewer(palette = "Blues") +
  labs(y = "",
       x = "", 
       title = "S. viride") +
  theme_bw() + 
  theme(plot.margin = margin(1, 1, 0, 0, unit = "pt"),
        axis.text.x = element_text(angle = 45, hjust = 1, size=7),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5, face = "italic")
        )

get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
  }
legend <- get_legend(vg_facet)

g <- grid.arrange(
  arrangeGrob(vg_qup, vg_stop, ncol=2), 
              arrangeGrob(legend), 
              ncol=2, widths = c(5,1), heights = c(1))
  
ggsave(here("figs/bc_bar_panel.png"),g)
```




```{r, eval = F, echo = F, message = F}
ggplot(filter(sum_ssp_vg, species_code != "rbp" & phase == "i"), aes(x = fr_mean, y = vg_mean)) +
  geom_point(shape=18) +
  facet_grid(~species) +
  labs(y = "Grazing impact (cm3/hr)",
       x = "Average feeding rate (bites/min)"
       title = "") +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        )
```


*Social feeding hypothesis.* more time must be spent vigilant in smaller groups, potential compounding effect with overfishing/loss of herbivory (e.g. Gil)

*Predation risk hypothesis.* Previous work has documented the suppressive effect of predator presence on herbivore feeding rates (Madin, Catano, McCauley?). 
- These studies have focused on natural predators (decoys or piscivore populations)
- While I found no clear relationship between large (>30cm) piscivore biomass and feeding trends (appendix), risk of predation from spearfishers may play a larger role in determining scarid grazing behavior at the reefs studied here. All Antiguan and Barbudan sites experience some degree of spearfishing pressure, while spearfishing has been banned in Bonaire since the 1970s. The 15-30cm individuals used in my behavioral observations are approaching size refuge from most natural predators, but would be likely targets for spearfishers. Both *S. vetula* and *S. viride* are commonly harvested species in Antigua and Barbuda.

- like with the social feeding hypothesis, spearfishing may have double impact of reducing fish and reducing grazing impact of remaining fish 

- often interaction of rugosity (e.g. Madin, stay near structure)
(Incorporate rugosity here - Rogers, Madin, Catano). Did not find strong evidence for this here, but carnivore biomass was strongly correllated with herbivore biomass and rugosity.

## Management implications + future research needs

* Potential reinforcing feedback loops in degraded reefs if high algal/low scarid reefs also have less grazing impact per scarid

* Limitations to this study: all these potential drivers/mechanisms are understandably correlated in observational work
    * Room for experimental work to unpack/distinguish drivers
* Need for incorporation of behavior in coral reef grazing models, especially those used to set targets for minimum herbivore biomass levels, because these may look very different in different reef conditions. Current paradigm of constant species-level grazing behaviors may be inaccurate. In Caribbean case, most models use Bonaire data which may not be representative of dynamics on more degraded Caribbean reefs.
* Need for framework to help incorporate behavioral effects into ecosystem management
* Conservation + mgmt implications: multiple human impacts on reefs may affect herbivore behavior in different ways, spec. fishing + habitat degradation - which may have reinforcing/compounding negative effects on reef health


In conclusion...

# Potential additions:

## PCA
```{r, echo=F, message=F, warning=F}
pca_pred <- prcomp(na.omit(sum_site %>%
                remove_rownames %>% column_to_rownames(var="site") %>%
                select(rugosity, ma_cover, ma_canopy, ta_cover, ta_canopy, scar_den, scar_bm, carn30_bm, lc_cover)),
  center = T, scale = T)

autoplot(pca_pred, data = sum_site, shape = 'island', colour = 'island',
         label = T,
         loadings = T, loadings.colour = 'gray',
         loadings.label = T, loadings.label.size = 3, loadings.label.colour = 'black',
            loadings.label.repel = T) +
    scale_color_manual(values = c("cadetblue3","cadetblue3","cadetblue3")) +
    theme_bw() +
    theme(legend.title = element_blank())
ggsave(here("figs/pca_pred.png"), width = 8, height = 5)

sum_site <- sum_site %>% 
  bind_cols(as.data.frame(pca_pred$x) %>% 
           select(PC1,PC2)) %>%
  rename(pc1_all=PC1,
         pc2_all=PC2)

sum_id_pca <- sum_id %>% 
  left_join(select(sum_site,site,pc1_all,pc2_all), by = "site")
sum_ssp_pca <- sum_ssp %>%
  left_join(select(sum_site,site,pc1_all,pc2_all), by = "site")
```

## GAMM results (see 5.8.19)


# Supplement

## Sample sizes
Current data subset: initial phase individuals only, above 15cm (eventual summary subset is 16-24cm...)

```{r}
sample <- sum_id %>% 
  filter(phase == "i" & species_code != "rbp" & length_cm <= 30) %>% 
  group_by(site, species, species_code, island) %>% 
  summarize(n=n())

sample_vir <- sum_id %>% 
  filter(phase == "i" & species_code == "stop" & length_cm <= 30) %>% 
  group_by(site, species, species_code, island) %>% 
  summarize(n=n())
sample_vir_sum <- sample_vir %>% 
  filter(site != "Pallaster West") %>% 
  group_by(species) %>% 
  summarize(n_sites = n(),
            n_total = sum(n),
            n_mean = mean(n),
            se = sd(n)/sqrt(n_sites))

sample_vet <- sum_id %>% 
  filter(phase == "i" & species_code == "qup" & length_cm <= 30) %>% 
  group_by(site, species, species_code, island) %>% 
  summarize(n=n())
sample_vet_sum <- sample_vet %>% 
  filter(!site %in% c("Pallaster East","Rendezvous","Turtle Bay")) %>%
  group_by(species) %>% 
  summarize(n_sites = n(),
            n_total = sum(n),
            n_mean = mean(n),
            se = sd(n)/sqrt(n_sites))

ggplot(sample, aes(x=factor(site, levels = sum_site$site), y=n)) +
        facet_grid(phase~species) +
        geom_bar(stat = "identity", aes(fill = island), position = "dodge") +
        scale_fill_manual(values = c("gray", "slategray2", "black")) +
        labs(title="Total sample") +
        theme_bw() +
        theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

