---
title: "Status Nov. 2018"
author: "Molly Wilson"
date: "Dec. 2018"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
    number_sections: true
---

```{r, echo=F, message=F, warning=F}
library(startR)
library(here)
library(tidyverse)
library(mgcv)
library(car)

sum_id_pca <- read.csv(here("data","sum_id_pca.csv"), stringsAsFactors=F) %>%
  select(-X) %>% na.omit()
sum_ssp_pca <- read.csv(here("data","sum_ssp_pca.csv"), stringsAsFactors=F) %>%
  select(-X) %>% na.omit()
```


# Intro + motivation

* Social-ecological role of CR herbivores, efforts to manage and maximize grazing impact
* Management targets/thresholds based on direct correlation between biomass and grazing impact
* In the Caribbean, data on parrotfish feeding behaviors are taken largely from Bonaire, one of the regions most pristine reef systems
* But little appreciation of fish behavior, understanding nuances of grazing impact
* Fished systems have been shown to exhibit altered flight behaviors, but implications for ecological function have not been assessed
* In this study I compare parrotfish grazing behavior between Bonaire, where spearfishing has been banned since the 1970s and parrotfish harvest was made illegal in the early 2000s, and Antigua, where spearfishing is prevalent and parrotfish populations have been substantially depleted.

# Methods

## Data collection
* Sites (13, map), timeline
* Fish and benthic community data
* Behavioral data:
    - Species: *Sparisoma viride* and *Scarus vetula*, initial and terminal phase greater than 15cm
    - 2 minute follows, calibration period, outside of previously established FID
    - Recording time budgets as well as bite rates during grazing forays (define)
    - Discarded data of incomplete follows or where fish were visably disturbed/fled
    - Timing of data collection distributed throughout day 

    
## Analysis
* One-way ANOVAs between islands, run separately for both S. vetula and S. viride on subset of individuals (initial phase, 16-24cm). In the cases where variables showed heteroskedasticity (Levene’s test, p<0.05), I did not assume homogeneity of variance (white.adjust=T within aov() function (car package) in R). If ANOVA results showed significant differences among islands, I used Tukey’s HSD to quantify these differences.
* Predicting community grazing impact: calculated length - feeding rate relationships using linear regression for each phase/island/species, applied these to observed site-level fish communities. Integrated bite size data from Bruggemann et al., then compared with predictions made with published species length - feeding rate relationships
* GAMM: mgcv, island as random effect, tested for collinearity using VIF (cutoff of 3), tested model validity. Used data aggregated to the site level
* SEM: lavaan OR piecewiseSEM?

# Results

## Differences in feeding behaviors among islands

```{r, echo=F, message=F, warning=F}
knitr::include_graphics(here("figs/vp_fr.png"))
knitr::include_graphics(here("figs/vp_br.png"))
knitr::include_graphics(here("figs/vp_gfrac.png"))
```

## Impacts on total grazing pressure

Here I take calculate the predicted reef area grazed per hour of a given scarid (*S. viride* and *S. vetula*) population. I calculate individual predicted grazing impact based on observed and previously published length - feeding rate relationships and multiply these based on published length - bite size relationships for each species.


```{r, echo=F, message=F, warning=F}
knitr::include_graphics(here("figs/sp_fr_length.png"))
```

Length - feeding rate relationships from personal data:  
$$fr(Antigua, S. viride, i) = 445-8*L$$
$$fr(Antigua, S. vetula, i) = 1030-12*L$$
$$fr(Bonaire, S. viride, i) = 1057-17*L$$
$$fr(Bonaire, S. vetula, i) = 1347+10*L$$

Feeding rates as published by Bruggemann/Bozec
$$fr(Published, S. viride, i) = 1089-17*L-56 $$
$$fr(Published, S. vetula, initial) = 3329-33*L$$

Bite sizes as predicted by Bruggemann/Bozec:
$$bs(S. vetula) = 4.013*10^{-4}*L^2$$
$$bs(S. viride) = 5.257*10^{-4}*L^2$$

```{r, echo=F, message=F, warning=F}
knitr::include_graphics(here("figs/areagrazed.png"))
```

## GAMM results

```{r, echo=F, message=F, warning=F}
knitr::include_graphics(here("figs/pca_bent.png"))
```

### Site-level data
```{r, echo=F, message=F, warning=F}
gamm_s <- gamm(fr_mean ~ species_code + phase + s(length_m) + s(pc1_bent) + s(pc2_bent) + s(scar_bm), 
           family = gaussian(link=identity),
           random = list(island=~1),
           method = "REML",
           data = sum_ssp_pca
           )
summary(gamm_s$gam)
plot(gamm_s$gam,pages=1)
plot(gamm_s$lme) # not too heteroskedastic?

```

Confirming low VIF among predictor variables with site-level model
```{r, echo=F, message=F, warning=F}
vif(lme(fr_mean ~ phase + length_m + scar_bm + pc1_bent + pc2_bent, 
        data = sum_ssp_pca,
        random = ~1 | island, 
        na.action = na.omit
        )) # all <3
```


### Individual-level data
```{r, warning=F, message=F, echo=F}
gamm_id <- gamm(fr ~ species_code + phase + s(length_cm) + s(pc1_bent) + s(pc2_bent) + s(scar_bm) 
              # +
              #   s(length_cm, by = as.numeric(species_code == "qup")) +
              #   s(pc1_bent, by = as.numeric(species_code == "qup")) +
              #   s(scar_bm, by = as.numeric(species_code == "qup"))
              , 
           family = gaussian(link=identity),
           random = list(island=~1),
           method = "REML",
           weights = varIdent(form =~ 1 | species),
           data = sum_id_pca
           )
summary(gamm_id$gam)
plot(gamm_id$gam,pages=1)
plot(gamm_id$lme) # shows some heteroskedasticity
```

Confirming low VIF among predictor variables with id-level model
```{r, warning=F, message=F, echo=F}
vif(lme(fr ~ species + phase + length_cm + scar_bm + pc1_bent + pc2_bent, 
        data = sum_id_pca,
        random = ~1 | island, 
        na.action = na.omit
        )) # prints strange when include RBP data
```

## SEM results?

```{r, echo=F, message=F, warning=F}
knitr::include_graphics(here("figs/sem.png"))
```

Notes: Still troubleshooting getting full SEM to run, unsure about how to deal with different data layers/sample sizes. If aggregating to the site level, I will be limited in the number of variables I can include (~8), though I could run separate models by species/phase. I could also use piecewise SEM (e.g. Miller et al. 2018), though does not allow for latent variables.