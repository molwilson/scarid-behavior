---
title: "Antigua-Barbuda Fish Follows August 2017"
author: "Molly Wilson"
date: "8/8/2017"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
    number_sections: true
---
```{r,message=FALSE,warning=FALSE}
# set up
library(lazyeval)
library(rmarkdown)
library(dplyr)
library(tidyr)
library(ggplot2)
library(grid)
library(reshape2)
library(data.table)
```

```{r, warning=FALSE, message= FALSE}
# import data
setwd("~/github/Scarid-Behavior/data")
follows <- read.csv("follows.csv", stringsAsFactors=FALSE) 
follows <- follows %>% filter(Date != "" & Date !="3/26/17") %>% select(-Activity.Code) %>% unite("fishID",c(Site,Diver,Date,Time,Follow.Number),sep=".", remove=FALSE)

# variable formatting
follows$Time.sec <- as.numeric(follows$Time.sec)
follows$Time.Fraction <- as.numeric(follows$Time.Fraction)
follows$Length.cm <- as.numeric(follows$Length.cm)
follows$Weight.g <- as.numeric(follows$Weight.g)
follows$Bites <- as.numeric(follows$Bites)
follows[c("Bites")][is.na(follows[c("Bites")])] <- 0
follows[follows == "#N/A"] <- NA

# create df with single row for all fish followed
sumID <- follows %>% group_by(fishID, Date, Island, Site, Species, Species.Code, Phase, Length.cm, Weight.g, Follow.sec) %>% dplyr::summarize()
# summarize sample size by site, species, phase
n.sspph <- group_by(sumID, Site, Species, Phase) %>% dplyr::summarize(n=n())
```

# Grazing behavior

## Time budgets 
Here I create a dataframe of time spent on each activity, per fish, in seconds and time fraction
```{r,warning=FALSE, message= FALSE}
TB <- group_by(follows, fishID, Activity, Species, Phase, Length.cm) %>% dplyr::summarize(time = sum(Time.sec), timefrac = sum(Time.Fraction))

# add time budgets per activity for each fish to 'sumID' (could re-do with dcast....)
TBgraze <- TB %>% filter(Activity == "graze") %>% subset(select=c(1,6,7))
colnames(TBgraze)[colnames(TBgraze)=="time"] <- "g.sec" # keep seconds for calculating grazing rates
colnames(TBgraze)[colnames(TBgraze)=="timefrac"] <- "g.frac"
sumID <- left_join(sumID, TBgraze, by= "fishID")
TBswim <- TB %>% filter(Activity == "swim") %>% subset(select=c(1,7))
colnames(TBswim)[colnames(TBswim)=="timefrac"] <- "swim.frac"
sumID <- left_join(sumID, TBswim, by= "fishID")
TBclean <- TB %>% filter(Activity == "cleaned") %>% subset(select=c(1,7))
colnames(TBclean)[colnames(TBclean)=="timefrac"] <- "clean.frac"
sumID <- left_join(sumID, TBclean, by= "fishID")
sumID[is.na(sumID)] <- 0
sumID$Length.cm[sumID$Length.cm==0]<-NA
```

## Grazing rates
```{r, warning=FALSE, message= FALSE}
# bites/second during total follow time and during grazing forays (including G1 instances)
bites <- follows %>% group_by(fishID) %>% dplyr::summarise(Bites = sum(Bites))
sumID <- left_join(sumID, bites, by="fishID") %>% mutate(BR=Bites/g.sec,FR=Bites/Follow.sec*60*60,TDB=Bites/Follow.sec*60*60*10.5)
sumID$BR[is.na(sumID$BR)] <- 0

# # bites/second during grazing forays, excluding G1 instances
# bites.noG1 <- follows %>% filter(Activity=="graze"&Bites>1&Time.sec>1) %>% group_by(fishID) %>% dplyr::summarize(Bites.noG1 = sum(Bites), g.sec.noG1=sum(Time.sec)) 
# sumID <- left_join(sumID, bites.noG1, by="fishID") %>% mutate(BR.g.noG1=Bites.noG1/g.sec.noG1)
# sumID$BR.g.noG1[is.na(sumID$BR.g.noG1)] <- 0
```

## Foray length and G1 bites
*Should I remove incomplete forays? What about forays >2min??*
```{r,warning=FALSE, message= FALSE}
forays <- follows %>% filter(Activity=="graze")
forays.complete <- follows %>% filter(!(Activity=="graze"&Min==0)&(lead(Activity)=="end")) # only complete forays, but not sure if I should actually exclude incomplete?
sum.forays <- forays %>% group_by(fishID) %>% dplyr::summarize(for.dur=mean(Time.sec),for.bites=mean(Bites))
sumID <- left_join(sumID,sum.forays, by="fishID")

# # frequency of G1 forays
# G1 <- forays %>% filter(Bites==1&Time.sec==1) %>% group_by(fishID) %>% dplyr::summarize(G1.freq=n())
# sumID <- left_join(sumID,G1, by="fishID")
# sumID$G1.freq[is.na(sumID$G1.freq)] <- 0
```

# Competitive interactions

## Summary of interactions per fish
```{r}
int.tot <- follows %>% filter(Initiator>=1) %>% group_by(fishID) %>% dplyr::summarise(int.tot=n())
int.scar <- follows %>% filter(Initiator>=1) %>% group_by(fishID) %>% filter(Competitor.Code=="stop" | Competitor.Code=="qup" | Competitor.Code=="rbp" | Competitor.Code=="prp" | Competitor.Code=="strp" | Competitor.Code=="rtp" | Competitor.Code=="ytp") %>% dplyr::summarise(int.scar=n())# total interaction instances
int.con <- follows %>% filter(Initiator>=1) %>% filter(Species==Competitor.Species) %>% group_by(fishID) %>% dplyr::summarise(int.con=n()) # interactions with conspecifics
int.hetscar <- follows %>% filter(Initiator>=1) %>% filter(Competitor.Code=="stop" | Competitor.Code=="qup" | Competitor.Code=="rbp") %>% filter(Species!=Competitor.Species) %>% group_by(fishID) %>% dplyr::summarise(int.hetscar=n()) # interactions with other scarid species
int.dam <- follows %>% filter(Initiator>=1) %>% filter(Competitor.Code=="dam") %>% group_by(fishID) %>% dplyr::summarise(int.dam=n()) # interactions with damselfish

# join and add to sumID dataframe
sumID <- sumID %>% left_join(int.tot, by="fishID") %>% left_join(int.scar, by="fishID") %>% left_join(int.con, by="fishID") %>% left_join(int.hetscar, by="fishID") %>% left_join(int.dam, by="fishID")
sumID[c("int.tot","int.scar","int.con","int.hetscar","int.dam")][is.na(sumID[c("int.tot","int.scar","int.con","int.hetscar","int.dam")])] <- 0
```

## Matrix of interactions by species
*eventually breakdown by site? region?*
```{r}
stop <- follows %>% filter(Species.Code=="stop") %>% dplyr::mutate(follows=n()) %>% filter(Competitor.Code %in% c("stop","qup","rbp","prp","rtp","strp")) %>% dplyr::group_by(Competitor.Code,Island) %>% dplyr::summarize(stop=n())
qup <- follows %>% filter(Species.Code=="qup") %>% dplyr::mutate(follows=n()) %>% filter(Competitor.Code %in% c("stop","qup","rbp","prp","rtp","strp")) %>% dplyr::group_by(Competitor.Code,Island) %>% dplyr::summarize(qup=n())
rbp <- follows %>% filter(Species.Code=="rbp") %>% dplyr::mutate(follows=n()) %>% filter(Competitor.Code %in% c("stop","qup","rbp","prp","rtp","strp")) %>% dplyr::group_by(Competitor.Code,Island) %>% dplyr::summarize(rbp=n())

intmatrix<-full_join(stop,qup,by=c("Competitor.Code","Island")) %>%full_join(rbp,by=c("Competitor.Code","Island"))
```

# Summarizing data by site, species, and phase
Next I create a summary tables that averages variables within each site/species/phase, then combines into one table
```{r,warning=FALSE, message= FALSE}
# site averages
fol.site <- sumID %>% group_by(Site,Island) %>% dplyr::summarize(n=n(),g.frac.mean=mean(g.frac),g.frac.se=sd(g.frac)/sqrt(n),BR.mean=mean(BR,na.rm=TRUE),BR.se=sd(BR,na.rm=TRUE)/sqrt(n),FR.mean=mean(FR),FR.se=sd(FR)/sqrt(n),for.dur.mean=mean(for.dur,na.rm=TRUE),for.dur.se=sd(for.dur,na.rm=TRUE)/sqrt(n),for.bites.mean=mean(for.bites,na.rm=TRUE),for.bites.se=sd(for.bites,na.rm=TRUE)/sqrt(n),int.tot.mean=mean(int.tot),int.tot.se=sd(int.tot)/sqrt(n), int.scar.mean=mean(int.scar),int.scar.se=sd(int.scar)/sqrt(n), int.con.mean=mean(int.con),int.con.se=sd(int.con)/sqrt(n), int.hetscar.mean=mean(int.hetscar),int.hetscar.se=sd(int.hetscar)/sqrt(n), int.dam.mean=mean(int.dam),int.dam.se=sd(int.dam)/sqrt(n)) %>% select(-n)

# site averages by species
fol.sp.site <- sumID %>% group_by(Site, Island, Species.Code) %>% dplyr::summarize(n=n(),g.frac.mean=mean(g.frac),g.frac.se=sd(g.frac)/sqrt(n),BR.mean=mean(BR,na.rm=TRUE),BR.se=sd(BR,na.rm=TRUE)/sqrt(n),FR.mean=mean(FR),FR.se=sd(FR)/sqrt(n),for.dur.mean=mean(for.dur,na.rm=TRUE),for.dur.se=sd(for.dur,na.rm=TRUE)/sqrt(n),for.bites.mean=mean(for.bites,na.rm=TRUE),for.bites.se=sd(for.bites,na.rm=TRUE)/sqrt(n), int.tot.mean=mean(int.tot),int.tot.se=sd(int.tot)/sqrt(n), int.scar.mean=mean(int.scar),int.scar.se=sd(int.scar)/sqrt(n), int.con.mean=mean(int.con),int.con.se=sd(int.con)/sqrt(n), int.hetscar.mean=mean(int.hetscar),int.hetscar.se=sd(int.hetscar)/sqrt(n), int.dam.mean=mean(int.dam),int.dam.se=sd(int.dam)/sqrt(n)) %>% select(-n) 
site.fol.sp<-dcast(setDT(fol.sp.site),Site~Species.Code,value.var=c("g.frac.mean","g.frac.se","int.scar.mean","int.scar.se"))

# site averages by species and phase
fol.sp.ph.site <- sumID %>% group_by(Site, Island, Species.Code, Phase) %>% dplyr::summarize(n=n(),g.frac.mean=mean(g.frac),g.frac.se=sd(g.frac)/sqrt(n),BR.mean=mean(BR,na.rm=TRUE),BR.se=sd(BR,na.rm=TRUE)/sqrt(n),FR.mean=mean(FR),FR.se=sd(FR)/sqrt(n),for.dur.mean=mean(for.dur,na.rm=TRUE),for.dur.se=sd(for.dur,na.rm=TRUE)/sqrt(n),for.bites.mean=mean(for.bites,na.rm=TRUE),for.bites.se=sd(for.bites,na.rm=TRUE)/sqrt(n), int.tot.mean=mean(int.tot),int.tot.se=sd(int.tot)/sqrt(n), int.scar.mean=mean(int.scar),int.scar.se=sd(int.scar)/sqrt(n), int.con.mean=mean(int.con),int.con.se=sd(int.con)/sqrt(n), int.hetscar.mean=mean(int.hetscar),int.hetscar.se=sd(int.hetscar)/sqrt(n), int.dam.mean=mean(int.dam),int.dam.se=sd(int.dam)/sqrt(n)) %>% select(-n)
site.fol.sp.ph<-dcast(setDT(fol.sp.ph.site),Site~Species.Code+Phase,value.var=c("g.frac.mean","g.frac.se","int.scar.mean","int.scar.se"))

# join into single file
site.follows <- fol.site %>% left_join(site.fol.sp, by="Site") %>% left_join(site.fol.sp.ph, by="Site")
```

## Export csvs for integration with site data
```{r,message=FALSE,warning=FALSE}
# write.csv(sumID,file="sumID.csv")
# write.csv(fol.sp.site,file="fol.sp.site.csv")
# write.csv(fol.sp.ph.site,file="fol.sp.ph.site.csv")
```

### 1.2 Import and format files
```{r, echo=FALSE,message=FALSE,warning=FALSE}
setwd("~/github/Scarid-Behavior/data")
site.fish<-read.csv("site.fish.csv", stringsAsFactors=FALSE)%>% select(-X)
site.benthic<-read.csv("site.benthic.csv", stringsAsFactors=FALSE)%>% select(-X)
site.human<-read.csv("site.human.csv", stringsAsFactors=FALSE)
species.site<-read.csv("species.site.csv",stringsAsFactors = FALSE)%>% filter(Species=="Sparisoma viride" | Species=="Scarus vetula" | Species=="Sparisoma aurofrenatum") %>% select(-X,-Family,-n,-L.n)
names(species.site)[3:8] <- c("conspec.BM","conspec.BM.se","conspec.DEN","conspec.DEN.se","conspec.L","conspec.L.se")
```
### 1.3 Join datasets, print .csv
```{r, echo=FALSE,message=FALSE,warning=FALSE}
# integrate all site-level variables
site.sum <- site.follows %>% left_join(site.fish,by="Site") %>% left_join(site.benthic,by="Site") %>% left_join(site.human,by="Site") 
# then join site-level data to sumID dataframe
sumID2 <- sumID %>% left_join(site.fish,by="Site") %>% left_join(site.benthic,by="Site") %>% left_join(site.human,by="Site")
# calculate conspecifc scarid variable to add to sumID2 (based on fish site/species)
sumID2 <- sumID2 %>% left_join(species.site,by=c("Site","Species"))

write.csv(site.sum,file="site.sum.csv")
write.csv(sumID2,file="sumID2.csv")
```

